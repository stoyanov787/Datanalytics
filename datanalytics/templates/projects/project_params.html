{% extends "base.html" %}

{% block content %}
{% load static %}
{% load widget_tweaks %}

<div class="container-fluid mt-5">
    <h1 class="fw-bold mb-5">Configure Parameters</h1>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <img class="card-img-top mb-3" src="{% static 'analysis.svg' %}" alt="Configure Parameters">

                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="mb-3">
                            {{ form.criterion_column.label_tag }}
                            {% render_field form.criterion_column class="form-select" %}
                        </div>

                        <div class="mb-3">
                            {{ form.observation_date_column.label_tag }}
                            {% render_field form.observation_date_column class="form-select" %}
                        </div>

                        <div class="mb-3">
                            {{ form.secondary_criterion_columns.label_tag }}
                            {% render_field form.secondary_criterion_columns class="form-select" %}
                        </div>

                        <div id="dependent-fields">
                            <div class="mb-3">
                                {{ form.t1df.label_tag }}
                                {% render_field form.t1df class="form-select" %}
                            </div>

                            <div class="mb-3">
                                {{ form.t2df.label_tag }}
                                {% render_field form.t2df class="form-select" %}
                            </div>

                            <div class="mb-3">
                                {{ form.t3df.label_tag }}
                                {% render_field form.t3df class="form-select" %}
                            </div>

                            <div class="mb-3">
                                {{ form.periods_to_exclude.label_tag }}
                                <div class="multi-select-container">
                                    {% for checkbox in form.periods_to_exclude %}
                                    <div class="form-check">
                                        {{ checkbox }}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form.columns_to_exclude.label_tag }}
                            <div class="multi-select-container">
                                {% for checkbox in form.columns_to_exclude %}
                                <div class="form-check">
                                    {{ checkbox }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form.optimal_binning_columns.label_tag }}
                            <div class="multi-select-container">
                                {% for checkbox in form.optimal_binning_columns %}
                                <div class="form-check">
                                    {{ checkbox }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success btn-lg mb-3 mt-3">Configure</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .multi-select-container {
        max-height: 200px;
        overflow-y: auto;
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const observationDateSelect = document.getElementById('{{ form.observation_date_column.id_for_label }}');
        
        if (observationDateSelect) {
            observationDateSelect.addEventListener('change', function() {
                const selectedColumn = this.value;
                updateDependentFields(selectedColumn);
            });
        }

        function updateDependentFields(column) {
            fetch(`/projects/get-date-values/?column=${encodeURIComponent(column)}&project_name={{ project.name }}`)
                .then(response => response.json())
                .then(data => {
                    if (data.dates) {
                        // Update time period dropdowns
                        updateSelect('{{ form.t1df.id_for_label }}', data.dates);
                        updateSelect('{{ form.t2df.id_for_label }}', data.dates);
                        updateSelect('{{ form.t3df.id_for_label }}', data.dates);
                        
                        // Update periods to exclude checkboxes
                        updateCheckboxes('periods_to_exclude', data.dates);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function updateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            if (select) {
                const currentValue = select.value;
                select.innerHTML = '';
                
                options.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    if (option === currentValue) {
                        opt.selected = true;
                    }
                    select.appendChild(opt);
                });
            }
        }

        function updateCheckboxes(fieldName, options) {
            const container = document.querySelector(`.multi-select-container:has([name^="${fieldName}"])`);
            if (container) {
                container.innerHTML = '';
                
                options.forEach((option, index) => {
                    const div = document.createElement('div');
                    div.className = 'form-check';
                    
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.name = `${fieldName}`;
                    input.value = option;
                    input.id = `id_${fieldName}_${index}`;
                    input.className = 'form-check-input';
                    
                    const label = document.createElement('label');
                    label.className = 'form-check-label';
                    label.htmlFor = input.id;
                    label.textContent = option;
                    
                    div.appendChild(input);
                    div.appendChild(label);
                    container.appendChild(div);
                });
            }
        }
    });
</script>

{% endblock %}